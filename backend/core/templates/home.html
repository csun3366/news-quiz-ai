{% extends 'base.html' %}
{% load static %}
  {% block content %}
  <!-- ä¸»é¡Œé¸æ“‡å€å¡Š -->
  <div class="flex items-center justify-center min-h-screen" id="topic-section">
    <div class="w-full max-w-xl px-6 text-center">
      <h1 class="text-5xl font-extrabold mb-4 tracking-tight">NewsTutor</h1>
      <h2 class="sr-only">é–‹å§‹ä½ çš„ AI æ–°èè‹±æ–‡é–±è®€ç·´ç¿’</h2>
      <h3 class="text-lg text-gray-400 mb-10">ç”¨ AI æŠŠåœ‹éš›æ–°èè®Šæˆä½ çš„æ¯æ—¥é–±è®€ç·´ç¿’</h3>

      <div class="mb-6 text-left">
        <label for="source" class="block mb-2 text-lg font-medium">é¸æ“‡ä¾†æºï¼š</label>
        <select id="source" class="bg-[#1C1E26] border border-gray-600 rounded px-4 py-2 w-full text-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
          <option value="CNN">CNN</option>
          <option value="BBC">BBC</option>
        </select>
      </div>

      <div class="mb-6 text-left">
        <label for="topic" class="block mb-2 text-lg font-medium">é¸æ“‡ä¸»é¡Œï¼š</label>
        <select id="topic" class="bg-[#1C1E26] border border-gray-600 rounded px-4 py-2 w-full text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="world">åœ‹éš›</option>
          <option value="tech">ç§‘æŠ€</option>
          <option value="business">å•†æ¥­</option>
          <option value="entertainment">å¨›æ¨‚</option>
          <option value="sport">é‹å‹•</option>
        </select>
      </div>

      <button onclick="searchArticles()" class="bg-blue-600 hover:bg-blue-700 w-full py-3 text-lg font-semibold rounded transition-all duration-200">
        æœç´¢æ–‡ç« 
      </button>
    </div>
  </div>

  <!-- æ–‡ç« å€å¡Š -->
  <section class="max-w-5xl mx-auto px-6 pt-6" id="content-section">
    <section id="articles" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden mt-4"></section>

    <!-- é¡¯ç¤ºé¸å–çš„æ–‡ç« æ¨™é¡Œ -->
    <div id="selected-article-title" class="hidden mt-10 mb-4 text-xl font-semibold text-white"></div>

    <!-- é¡Œå‹é¸æ“‡ -->
    <div id="question-options" class="mb-6 hidden mt-10">
      <label for="type" class="block mb-2 text-lg font-medium mt-8">é¸æ“‡é¡Œå‹ï¼š</label>
      <select id="type" class="bg-[#1C1E26] border border-gray-600 rounded px-4 py-2 w-full text-lg focus:outline-none focus:ring-2 focus:ring-green-500">
        <option value="reading">é–±è®€ç†è§£</option>
        <!-- TODO: ç›®å‰åªæ”¯æ´é–±è®€ç†è§£ -->
        <!-- <option value="cloze">å…‹æ¼å­—</option>  -->
        <!-- <option value="summary">æ‘˜è¦å¡«ç©º</option>  -->
      </select>
    </div>

    <!-- ç”Ÿæˆè©¦é¡ŒæŒ‰éˆ• -->
    <button id="generate-btn" onclick="generateQuestions()" class="hidden bg-green-600 hover:bg-green-700 w-full py-3 text-lg font-semibold rounded mb-10 transition-all duration-200">
      ç”Ÿæˆç·´ç¿’é¡Œ
    </button>

    <!-- é¡Œç›®å€ -->
    <section id="question-area" class="hidden bg-[#1C1E26] p-6 rounded-lg">
      <!-- å‹•æ…‹æ¨™é¡Œï¼šé¡¯ç¤ºé¡Œå‹èˆ‡æ–‡ç« æ¨™é¡Œ -->
      <!-- é¡Œç›®è³‡è¨Š -->
      <div class="mb-6">
        <p id="question-type-display" class="text-sm text-gray-400 uppercase tracking-wider mb-1">
          é¡Œç›®é¡å‹ï¼šé–±è®€ç†è§£
        </p>
        <h2 id="question-title-display" class="text-2xl md:text-3xl font-semibold text-white leading-snug">
          æ¨™é¡Œï¼šChildren make up half of more than 170 killed in Pakistan floods
        </h2>
      </div>

      <!-- é¡¯ç¤ºæ–‡ç« å…§å®¹ -->
      <div id="article-content" class="mb-6 text-gray-200 whitespace-pre-wrap leading-relaxed text-lg"></div>

      <!-- é¡Œç›®å®¹å™¨ -->
      <div id="questions-container" class="mb-6"></div>

      <!-- é¡¯ç¤ºç­”é¡Œçµæœ -->
      <div id="result" class="text-green-400 font-semibold mt-4"></div>
      <button onclick="submitAnswers()"
              class="mt-4 bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded text-white font-semibold hidden"
              id="submit-btn">
        é€å‡ºç­”æ¡ˆ
      </button>
      
      <!-- å–®å­—èˆ‡ç‰‡èªå­¸ç¿’å€ -->
      <div id="vocab-phrase-section" class="mt-10 hidden">
        <h3 class="text-2xl font-semibold text-white mb-4">ğŸ“š å–®å­—èˆ‡ç‰‡èªè§£æ</h3>

        <!-- å–®å­— -->
        <div id="vocabulary-list" class="mb-8">
          <h4 class="text-xl font-semibold text-blue-400 mb-2">ğŸ”¤ å–®å­—è§£æ</h4>
          <ul class="space-y-4 text-gray-300 text-lg list-disc pl-6"></ul>
        </div>

        <!-- ç‰‡èª -->
        <div id="phrase-list">
          <h4 class="text-xl font-semibold text-green-400 mb-2">ğŸ§© ç‰‡èªè§£æ</h4>
          <ul class="space-y-4 text-gray-300 text-lg list-disc pl-6"></ul>
        </div>
      </div>
    </section >

    <!-- åº•éƒ¨è£é£¾ -->
    <div class="mt-12 h-2 w-full bg-gradient-to-r from-blue-600 via-blue-400 to-gray-500 rounded-full"></div>
  </section>

  <!-- JS -->
  <script>
    const topicSelect = document.getElementById('topic');
    const sourceSelect = document.getElementById('source');

    const topics = {
      CNN: [
        { value: 'world', label: 'åœ‹éš›' },
        { value: 'tech', label: 'ç§‘æŠ€' },
        { value: 'business', label: 'å•†æ¥­' },
        { value: 'entertainment', label: 'å¨›æ¨‚' },
        { value: 'sport', label: 'é‹å‹•' },
      ],
      BBC: [
        { value: 'world', label: 'åœ‹éš›' },
        { value: 'business', label: 'å•†æ¥­' },
        { value: 'technology', label: 'ç§‘æŠ€' },
        { value: 'entertainment_and_arts', label: 'å¨›æ¨‚èˆ‡è—è¡“' },
        { value: 'sport', label: 'é‹å‹•' },
      ]
    };

    function updateTopicOptions() {
      const selectedSource = sourceSelect.value;
      const selectedTopics = topics[selectedSource] || [];

      topicSelect.innerHTML = '';
      selectedTopics.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        topicSelect.appendChild(option);
      });
    }

    sourceSelect.addEventListener('change', updateTopicOptions);
    window.addEventListener('DOMContentLoaded', updateTopicOptions);

    function getEmojiForCategory(category) {
      switch (category) {
        case 'world': return 'ğŸŒ';
        case 'business': return 'ğŸ’¼';
        case 'tech': return 'ğŸ’»';
        case 'health': return 'ğŸ§¬';
        case 'markets': return 'ğŸ“Š';
        default: return 'ğŸ“°';
      }
    }
    async function searchArticles() {
      const source = document.getElementById('source').value;
      const topic = document.getElementById('topic').value;
      const container = document.getElementById('articles');
      container.innerHTML = ''; // æ¸…ç©ºæ–‡ç« 

      // åˆ¤æ–·æ–‡ç« é•·åº¦
      function getArticleLengthLabel(wordCount) {
        if (wordCount < 500) return { label: "çŸ­ç¯‡", color: "bg-green-500/80" };
        if (wordCount < 1500) return { label: "ä¸­ç¯‡", color: "bg-yellow-500/80" };
        return { label: "é•·ç¯‡", color: "bg-red-500/80" };
      }

      try {
        const response = await fetch(`/api/articles/?source=${source}&category=${topic}`);
        const data = await response.json();

        if (!Array.isArray(data)) {
          container.innerHTML = '<p class="text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
          container.classList.remove('hidden');
          return;
        }

        data.forEach((article, index) => {
          const wordCount = (article.content || "").split(/\s+/).length;
          const lengthInfo = getArticleLengthLabel(wordCount);

          const card = document.createElement('article');
          card.className = 'relative bg-[#1C1E26] rounded-lg p-5 cursor-pointer border border-transparent hover:border-blue-500 transition';
          card.onclick = () => selectArticle(index); // å¯æ”¹ç‚ºå‚³ article.id

          card.innerHTML = `
            <div class="text-2xl mb-4">${getEmojiForCategory(article.category)}</div>
            <h3 class="text-xl font-semibold mb-1">${article.title}</h3>
            <p class="text-gray-400 text-sm leading-relaxed mb-8">
              ${(article.summary || article.content.slice(0, 100))}...
            </p>
            <!-- å³ä¸‹è§’æµ®å‹•æ¨™ç±¤ -->
            <div class="absolute bottom-3 right-3 flex items-center gap-2 text-xs">
              <span class="px-2 py-1 rounded-full text-white ${lengthInfo.color} shadow-sm">
                ${lengthInfo.label}
              </span>
              <span class="text-gray-400">${wordCount}å­—</span>
            </div>
          `;

          container.appendChild(card);
        });

        container.classList.remove('hidden');
        setTimeout(() => {
          container.scrollIntoView({ behavior: 'smooth' });
        }, 100);
      } catch (error) {
        container.innerHTML = '<p class="text-red-500">ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
        container.classList.remove('hidden');
      }
    }

    function selectArticle(index) {
      const allCards = document.querySelectorAll('#articles > article');
      allCards.forEach(card => card.classList.remove('border-blue-500'));
      allCards[index].classList.add('border-blue-500');

      const source = document.getElementById('source').value;
      const topic = document.getElementById('topic').value;

      fetch(`/api/articles/?source=${source}&category=${topic}`)
        .then(res => res.json())
        .then(data => {
          selectedArticle = data[index];

          // é¡¯ç¤ºé¸ä¸­çš„æ¨™é¡Œ
          const titleBox = document.getElementById('selected-article-title');
          titleBox.textContent = `ä½ é¸æ“‡çš„æ˜¯ï¼š${selectedArticle.title}`;
          titleBox.classList.remove('hidden');

          document.getElementById('question-options').classList.remove('hidden');
          document.getElementById('generate-btn').classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('question-options').scrollIntoView({ behavior: 'smooth' });
          }, 300);
        });
    }

    function getTypeName(code) {
      switch (code) {
        case 'cloze': return 'å…‹æ¼å­—';
        case 'reading': return 'é–±è®€ç†è§£';
        case 'summary': return 'æ‘˜è¦å¡«ç©º';
        default: return 'æœªçŸ¥é¡å‹';
      }
    }

    let currentQuestions = [];

    async function generateQuestions() {
      if (!selectedArticle) return;

      const type = document.getElementById("type").value;
      const questionArea = document.getElementById("question-area");
      document.getElementById("question-type-display").textContent = `é¡Œç›®é¡å‹ï¼š${getTypeName(type)}`;
      document.getElementById("question-title-display").textContent = `${selectedArticle.title}`; 
      const articleContentEl = document.getElementById("article-content");
      const questionsContainer = document.getElementById("questions-container");
      const resultBox = document.getElementById("result");

      questionArea.classList.remove("hidden");
      articleContentEl.textContent = "é¡Œç›®ç”Ÿæˆä¸­...";
      questionsContainer.innerHTML = "";
      resultBox.innerHTML = "";

      try {
        const res = await fetch("/api/generate_questions/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: selectedArticle.title,
            content: selectedArticle.content,
            type: type,
          }),
        });

        const data = await res.json();
        if (type !== "cloze") {
          articleContentEl.textContent = data.article_content;
        } else {
          articleContentEl.textContent = data.article_content || selectedArticle.content.slice(0, 300) + "...";
        }

        if (Array.isArray(data.questions) && data.questions.length > 0) {
          currentQuestions = data.questions;

          data.questions.forEach((q, idx) => {
            const qDiv = document.createElement("div");
            qDiv.className = "mb-6";

            // é¡Œå¹¹å€å¡Š
            const questionText = document.createElement("p");
            questionText.className = "font-semibold mb-2";

            if (type === "cloze") {
              questionText.innerHTML = `${idx + 1}. ${q.sentence}`;
            } else {
              // é–±è®€ç†è§£é¡Œ
              questionText.textContent = `${idx + 1}. ${q.question}`;
            }

            qDiv.appendChild(questionText);

            // é¸é …
            if (q.options) {
              const optionLabels = ["A", "B", "C", "D"];
              q.options.forEach((option, i) => {
                const label = document.createElement("label");
                label.className = "block mb-1 cursor-pointer";

                const radio = document.createElement("input");
                radio.type = "radio";
                radio.name = `question_${idx}`;
                radio.value = option;
                radio.className = "mr-2";

                label.appendChild(radio);
                label.appendChild(document.createTextNode(`${optionLabels[i]}. ${option}`));
                qDiv.appendChild(label);
              });
            }

            questionsContainer.appendChild(qDiv);
            document.getElementById("submit-btn").classList.remove("hidden");
          });
        } else {
          questionsContainer.innerHTML = '<p class="text-red-400">æ²’æœ‰é¡Œç›®è³‡æ–™ã€‚</p>';
        }

        // é¡¯ç¤ºå–®å­—èˆ‡ç‰‡èª
          const vocabSection = document.getElementById("vocab-phrase-section");
          const vocabList = document.querySelector("#vocabulary-list ul");
          const phraseList = document.querySelector("#phrase-list ul");

          console.log(data)
          if (Array.isArray(data.vocabulary) && data.vocabulary.length > 0) {
            vocabList.innerHTML = '';
            data.vocabulary.forEach(v => {
              const item = document.createElement('li');
              item.innerHTML = `
  <div class="pl-4 mb-4">
    <p class="text-lg font-bold text-white">
      ${v.word} <span class="text-sm italic text-gray-300 ml-2">(${v.part_of_speech})</span>
    </p>
    <p class="text-white">${v.translation}</p>
    <p class="text-sm text-gray-300">${v.example}</p>
  </div>
`;
              vocabList.appendChild(item);
              console.log(item.innerHTML)
            });
          }

          if (Array.isArray(data.phrases) && data.phrases.length > 0) {
            phraseList.innerHTML = '';
            data.phrases.forEach(p => {
              const item = document.createElement('li');
              item.innerHTML = `
  <div class="pl-4 mb-4">
    <p class="text-lg font-bold text-white">
      ${p.phrase}
    </p>
    <p class="text-white">${p.translation}</p>
    <p class="text-sm text-gray-300">${p.example}</p>
  </div>
`;
              phraseList.appendChild(item);
              console.log(item.innerHTML)
            });
          }

          vocabSection.classList.remove("hidden");

        questionArea.scrollIntoView({ behavior: "smooth" });
      } catch (error) {
        console.error(error);
        articleContentEl.textContent = "";
        questionsContainer.innerHTML = '<p class="text-red-400">ç”Ÿæˆé¡Œç›®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
      }
    }

    function submitAnswers() {
      const resultBox = document.getElementById("result");
      let correctCount = 0;

      currentQuestions.forEach((q, idx) => {
        const radios = document.getElementsByName(`question_${idx}`);
        let userAnswer = null;
        for (const r of radios) {
          if (r.checked) {
            userAnswer = r.value;
            break;
          }
        }

        const questionDiv = radios[0]?.closest('div');  // æ‰¾åˆ°è©²é¡Œçš„å®¹å™¨

        let feedback = '';

        if (userAnswer === q.answer) {
          correctCount++;
          feedback = `<p class="text-green-400 mt-1">âœ… ä½ ç­”å°äº†</p>`;
        } else {
          feedback = `
            <p class="text-red-400 mt-1">âŒ ä½ ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<span class="font-bold">${q.answer}</span></p>
          `;
        }

        feedback += `
          <p class="text-gray-400 mt-1">è©³è§£ï¼š${q.explanation || 'ç„¡æä¾›è©³è§£'}</p>
        `;

        if (questionDiv) {
          let existingFeedback = questionDiv.querySelector('.feedback');
          if (existingFeedback) {
            existingFeedback.innerHTML = feedback;
          } else {
            const fb = document.createElement('div');
            fb.className = 'feedback mt-2';
            fb.innerHTML = feedback;
            questionDiv.appendChild(fb);
          }
        }
      });

      resultBox.textContent = `ä½ ç­”å°äº† ${correctCount} é¡Œï¼Œå…± ${currentQuestions.length} é¡Œ`;
    }

  </script>
  {% endblock %}
