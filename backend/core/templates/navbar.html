{% load static %}
{% load socialaccount %}
<!-- 為了讓 provider_login_url 'google'	產生 Google 登入的連結 URL "/accounts/google/login/" -->

<!-- Navbar -->
<nav class="bg-[#1C1E26] border-b border-gray-700 py-1.5 px-6 flex justify-between items-center fixed top-0 w-full z-50">
  <div class="text-2xl font-bold tracking-tight">
    <a href="/" class="text-lg text-white hover:text-blue-400 transition">NewsTutor</a>
  </div>
  <div class="flex items-center space-x-4">

    <!-- 定價按鈕（跟登入同樣樣式） -->
    <a href="/pricing/" class="btn btn-outline-light me-2">
      定價
    </a>

    {% if user.is_authenticated %}
    <div class="relative">
      <!-- 點擊頭像開關選單 -->
      <button id="avatar-toggle" class="flex items-center focus:outline-none">
        <img src="{% static 'default-avatar.png' %}"
            alt="Avatar"
            class="w-9 h-9 rounded-full border-2 border-white hover:ring-2 ring-blue-500 transition" />
      </button>

      <!-- 下拉選單 -->
      <div id="avatar-menu" class="hidden absolute right-0 mt-2 w-48 bg-[#2A2C36] rounded-lg shadow-lg text-white z-50">
        <a href="#" class="block px-4 py-2 hover:bg-gray-700 transition">帳戶資訊</a>
        <button onclick="document.getElementById('logout-modal').classList.remove('hidden')"
                class="block w-full text-left px-4 py-2 hover:bg-gray-700 transition">
          登出
        </button>
      </div>
    </div>

    <script>
      const avatarToggle = document.getElementById('avatar-toggle');
      const avatarMenu = document.getElementById('avatar-menu');

      // 點擊切換顯示/隱藏
      avatarToggle.addEventListener('click', function (e) {
        e.stopPropagation(); // 不冒泡到 document
        avatarMenu.classList.toggle('hidden');
      });

      // 點擊畫面其他地方時自動關閉
      document.addEventListener('click', function () {
        avatarMenu.classList.add('hidden');
      });

      // 如果點擊選單本身就不要關閉（避免選單點擊馬上消失）
      avatarMenu.addEventListener('click', function (e) {
        e.stopPropagation();
      });
    </script>
    {% else %}
      <a class="btn btn-outline-light me-2" href="/accounts/google/login/">登入</a>
      <a href="/accounts/google/login/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
        免費試用
      </a>
    {% endif %}

  </div>
</nav>

<!-- 登出 Modal -->
<div id="logout-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-[#1E1F25] p-6 rounded-lg shadow-lg text-white max-w-sm w-full">
    <h2 class="text-lg font-semibold mb-4">確定要登出嗎？</h2>
    <div class="flex justify-end space-x-4">
      <button onclick="document.getElementById('logout-modal').classList.add('hidden')"
              class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">
        取消
      </button>
      <button onclick="logout()" class="px-4 py-2 bg-red-600 rounded hover:bg-red-700">
        確認登出
      </button>
    </div>
  </div>
</div>

<!-- 登出 Script -->
<script>
  function logout() {
    fetch("{% url 'account_logout' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie('csrftoken'),
        "Content-Type": "application/x-www-form-urlencoded"
      }
    }).then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        window.location.reload();
      }
    });
  }

  // Helper: 取得 CSRF token（從 cookie）
  function getCookie(name) {
    const value = "; " + document.cookie;
    const parts = value.split("; " + name + "=");
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
</script>
